
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <base href="/web001/">
<title>影響可視化システム WebUI</title>
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <link rel="stylesheet" href="./js/aoi-style.css" />
  <style>
    :root{--brand:#0a7bdc}
    *{box-sizing:border-box}
    body{margin:0;height:100vh;display:flex;font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans JP',Meiryo,sans-serif}

    #sidebar{width:280px;background:#f7f7f7;border-right:1px solid #dcdcdc;display:flex;flex-direction:column}
    #tabs{display:flex;gap:4px;padding:8px;background:#eee;position:sticky;top:0;z-index:2}
    #tabs button{flex:1 1 auto;padding:8px 6px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;font-weight:600}
    #tabs button.active{border-color:var(--brand);outline:2px solid rgba(10,123,220,.15)}
    .tab{padding:10px;overflow:auto;height:calc(100vh - 50px)}
    .field{margin:8px 0}
    .field label{display:block;font-size:12px;margin-bottom:4px;color:#555}
    .field input,.field button{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;background:#fff}
    .btn{background:var(--brand);color:#fff;border-color:var(--brand);cursor:pointer}
    .note{font-size:12px;color:#666;margin-top:6px}

    #mapwrap{position:relative;flex:1}
    #map{width:100%;height:100%}
    #tools{position:absolute;right:8px;top:8px;display:flex;flex-direction:column;gap:8px;z-index:4}
    .tbtn{padding:8px 10px;background:#fff;border:1px solid #ddd;border-radius:10px;font-size:12px;cursor:pointer}
    .tbtn.active{outline:2px solid var(--brand);border-color:var(--brand)}

    #legend{position:absolute;right:10px;bottom:160px;background:#fff;border:1px solid #ddd;border-radius:8px;padding:8px 10px;font-size:12px;z-index:3;width:200px}
    #credits{position:absolute;right:10px;bottom:10px;background:#fff;border:1px solid #ddd;border-radius:8px;padding:8px 10px;font-size:11px;color:#333;z-index:2;width:320px;line-height:1.35}
    .sw{display:inline-block;width:12px;height:12px;margin-right:6px;border:1px solid #ccc;vertical-align:middle}
    .row{display:flex;align-items:center;gap:6px;margin:4px 0}

    #indicator{position:absolute;top:10px;right:130px;background:#fff;border:1px solid #ccc;border-radius:6px;padding:4px 8px;font-size:12px;z-index:5;display:flex;align-items:center;gap:6px}
    #indicator select{font-size:12px}

    /* Fix 1: AOI Canvas default does NOT eat mouse events */
    #aoi-canvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;background:transparent}

    /* Simple toast */
    #toast{position:absolute;top:12px;left:12px;z-index:6;background:#111;color:#fff;padding:8px 12px;border-radius:8px;display:none;opacity:.92;font-size:12px}
  </style>
</head>
<body>
  <aside id="sidebar">
    <div id="tabs">
      <button class="tabbtn active" data-id="home">ホーム</button>
      <button class="tabbtn" data-id="compute">計算</button>
      <button class="tabbtn" data-id="history">履歴</button>
      <button class="tabbtn" data-id="report">レポート</button>
    </div>

    <section id="home" class="tab">
      <div class="field">
        <label for="addr">住所検索（国土地理院 AddressSearch）</label>
        <input id="addr" type="text" placeholder="例：香川県、広島市、山中町３－１－２ など" />
        <ul id="suggest" class="addr-suggest"></ul>
      </div>
      <div class="field"><button class="btn" id="btnGeo">地図へ移動</button></div>
      <p class="note">※ 候補リストをクリックでも移動します。</p>
    </section>

    <section id="compute" class="tab" hidden>
      <div class="field"><label for="start">対象開始時間</label><input id="start" type="datetime-local"/></div>
      <div class="field"><label for="end">対象終了時間</label><input id="end" type="datetime-local"/></div>
      <div class="field"><button class="btn" id="btnRun">計算を実行（選択AOIで）</button></div>
      <p class="note">AOIを確定してから実行してください。</p>
    </section>

    <section id="history" class="tab" hidden>
      <div id="hist" class="hist"></div>
    </section>

    <section id="report" class="tab" hidden>
      <div class="field"><button class="btn" id="btnReport">レポート出力（ダミー）</button></div>
    </section>
  </aside>

  <main id="mapwrap">
    <div id="map"></div>
    <canvas id="aoi-canvas"></canvas>
    <div id="toast"></div>

    <div id="indicator">
      <span>表示指標</span>
      <select id="layerSelector">
        <option value="traffic" selected>交通量</option>
        <option value="noise">騒音</option>
        <option value="co2">CO₂</option>
      </select>
    </div>

    <div id="tools">
      <button class="tbtn" id="btnAOI">範囲</button>
      <button class="tbtn" id="btnClose">通行止め</button>
      <button class="tbtn" id="btnGrid">グリッド</button>
      <button class="tbtn" id="btnBldg">建物</button>
    </div>

    <div id="legend">
      <strong>交通量</strong>
      <div class="row"><span class="sw" style="background:#e5f2ff"></span>小</div>
      <div class="row"><span class="sw" style="background:#ffd27a"></span>中</div>
      <div class="row"><span class="sw" style="background:#ff8a8a"></span>大</div>
    </div>

    <div id="credits">
      <div><strong>提供 / Credits</strong></div>
      地図ライブラリ：MapLibre GL JS<br/>
      背景タイル：国土地理院 地理院タイル（標準地図）<br/>
      住所検索：国土地理院 AddressSearch API（msearch.gsi.go.jp）
    </div>
  </main>

  <script>
    // 左タブ切り替え
    document.querySelectorAll('.tabbtn').forEach(b=>b.onclick=()=>{
      document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(x=>x.hidden=true);
      b.classList.add('active'); document.getElementById(b.dataset.id).hidden=false;
    });

    // シンプルトースト
    const toastBox=document.getElementById('toast');
    function toast(msg){ toastBox.textContent=msg; toastBox.style.display='block'; setTimeout(()=>toastBox.style.display='none', 2200); }
  </script>

  <script>
    // 地図（地理院タイル）
    const styleGSI={
      version:8,
      sources:{ gsi:{ type:'raster', tiles:['https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png'], tileSize:256, attribution:'地理院タイル（標準地図）' } },
      layers:[{ id:'gsi', type:'raster', source:'gsi' }]
    };
    const map=new maplibregl.Map({ container:'map', style:styleGSI, center:[132.4553,34.3853], zoom:13 });
    window.map = map; // グローバル公開（診断用）
    map.addControl(new maplibregl.NavigationControl(),'top-left');

    // グリッド（参考）
    let gridOn=false, gridSizeM=250;
    function m2deg(m,lat){const dlat=m/111320, dlng=m/(111320*Math.cos(lat*Math.PI/180)); return {dlat,dlng};}
    function gridGeo(){
      const b=map.getBounds(), lat=map.getCenter().lat, {dlat,dlng}=m2deg(gridSizeM,lat);
      const minX=Math.floor(b.getWest()/dlng)*dlng, maxX=Math.ceil(b.getEast()/dlng)*dlng;
      const minY=Math.floor(b.getSouth()/dlat)*dlat, maxY=Math.ceil(b.getNorth()/dlat)*dlat;
      const f=[]; 
      for(let x=minX;x<=maxX;x+=dlng){ f.push({type:'Feature',geometry:{type:'LineString',coordinates:[[x,minY],[x,maxY]]}}); }
      for(let y=minY;y<=maxY;y+=dlat){ f.push({type:'Feature',geometry:{type:'LineString',coordinates:[[minX,y],[maxX,y]]}}); }
      return {type:'FeatureCollection',features:f};
    }
    function ensureGrid(){ if(!map.getSource('grid')){ map.addSource('grid',{type:'geojson',data:gridGeo()});
      map.addLayer({id:'grid-line',type:'line',source:'grid',paint:{'line-color':'#2b8cff','line-width':1,'line-opacity':0.35}});
    } else { map.getSource('grid').setData(gridGeo()); } }
    function toggleGrid(){ gridOn=!gridOn; document.getElementById('btnGrid').classList.toggle('active',gridOn);
      if(gridOn) ensureGrid(); else { if(map.getLayer('grid-line')) map.removeLayer('grid-line'); if(map.getSource('grid')) map.removeSource('grid'); } }
    document.getElementById('btnGrid').onclick=toggleGrid; map.on('moveend',()=>{ if(gridOn) ensureGrid(); });
  </script>

  <!-- 連携スクリプト（Fix適用版） -->
  <script>window.__IMPACT_BUILD_TAG='final-20250914-145859';</script>
<script type="module">
    import { AOIDraw } from './js/system/aoi-draw.v3.js?v=final-20250914-145859';
    import { setupAddressForm } from './js/system/address-form.js';

    // ---- 住所フォーム（候補→flyTo） ----
    const addrInput  = document.getElementById('addr');
    const suggestBox = document.getElementById('suggest');
    setupAddressForm({
      input: addrInput,
      suggestBox,
      onResolve: (lng, lat) => map.flyTo({ center: [lng, lat], zoom: 16 })
    });
    document.getElementById('btnGeo').onclick=async()=>{
      const q=addrInput.value.trim(); if(!q){toast('住所を入力');return;}
      const res=await fetch('https://msearch.gsi.go.jp/address-search/AddressSearch?q='+encodeURIComponent(q));
      const j=await res.json(); if(!j.length){toast('該当なし');return;}
      const [lng,lat]=j[0].geometry.coordinates; map.flyTo({center:[lng,lat],zoom:16});
    };

    // ---- AOI描画（Fix 1: pointer-events 切替 / Fix 2: 形状を地図レイヤで保持） ----
    const canvas = document.getElementById('aoi-canvas');
    const resizeCanvas = () => { const r = document.getElementById('map').getBoundingClientRect(); canvas.width=r.width; canvas.height=r.height; };
    resizeCanvas(); window.addEventListener('resize', resizeCanvas); map.on('resize', resizeCanvas);

    let lastAOI = null;
    const aoi = new AOIDraw({
      canvas,
      proj: { project: (ll) => map.project(ll), unproject: (pt) => map.unproject(pt) },
      mode: 'polygon',
      onComplete: (geo) => {
        lastAOI = geo;
        // Fix 1: 完了時はイベントを戻す
        canvas.style.pointerEvents = 'none';

        // Fix 2: 形状を MapLibre のレイヤで残す
        const SRC_ID = 'impact-aoi';
        const FILL_ID = 'impact-aoi-fill';
        const LINE_ID = 'impact-aoi-line';
        if (!map.getSource(SRC_ID)) {
          map.addSource(SRC_ID, { type:'geojson', data: geo });
          if (geo.geometry.type === 'Polygon') {
            map.addLayer({ id:FILL_ID, type:'fill', source:SRC_ID, paint:{'fill-color':'#00aaff','fill-opacity':0.18} });
            map.addLayer({ id:LINE_ID, type:'line', source:SRC_ID, paint:{'line-color':'#0077cc','line-width':2} });
          } else {
            map.addLayer({ id:LINE_ID, type:'line', source:SRC_ID, paint:{'line-color':'#0077cc','line-width':2} });
          }
        } else {
          map.getSource(SRC_ID).setData(geo);
        }
        toast('AOIを確定しました（レイヤに保持）');
      }
    });

    const btnAOI = document.getElementById('btnAOI');
    btnAOI.onclick = () => {
      btnAOI.classList.add('active');
      // Fix 1: 描画中だけキャンバスがイベントを受け取る
      canvas.style.pointerEvents = 'auto';
      aoi.start('polygon');  // Shift=直交, Backspace=戻る, Enter=確定, Esc=キャンセル
    };

    // 「計算を実行」→最後のAOIでパイプライン（DataBus/Compute）
    const API = { extract: '/api/aoi/extract', compute: '/api/compute/run' };
const DEV_MOCK = true; // ★開発用：サーバ未接続でも動作確認
async function runPipeline(geo){
      const disable = (tf)=>['btnAOI','btnRun'].forEach(id=>{const el=document.getElementById(id); if(el) el.disabled=tf;});
      try{
        disable(true); toast('抽出中…');
        const r1 = await fetch(API.extract, { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ aoi: geo, output: 'csv', schema_version: '1.0.0', crs: 'EPSG:4326' }) });
        if(!r1.ok){
          if(DEV_MOCK){
            // 簡易モック：AOIの外形を元にラインを1本生成
            const coords = (geo.geometry.type==='Polygon') ? geo.geometry.coordinates[0] : [];
            const line = {type:'Feature', geometry:{type:'LineString', coordinates: coords.filter(Boolean)} , properties:{VC:0.6, segment_id:1}};
            return drawMock([line]);
          }
          throw new Error('extract failed');
        }
        const ext = await r1.json();
        toast('計算中…');
        const r2 = await fetch(API.compute, { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ aoi: geo, inputs:{ trafficCsv: ext.files?.traffic, buildingsCsv: ext.files?.buildings }, metric: 'traffic' }) });
        if(!r2.ok) throw new Error('compute failed');
        const cmp = await r2.json();
        toast('結果を描画します');
        if (cmp.resultGeojson) {
          const srcId='impact-result';
          if (!map.getSource(srcId)) {
            map.addSource(srcId, { type:'geojson', data: cmp.resultGeojson });
            map.addLayer({ id:'impact-fill', type:'fill', source:srcId,
              paint:{ 'fill-color':['interpolate',['linear'],['get','Score'],0,'#e5f2ff',1,'#ffd27a',2,'#ff8a8a'], 'fill-opacity':0.45 } });
            map.addLayer({ id:'impact-line', type:'line', source:srcId,
              paint:{ 'line-color':'#666','line-width':1,'line-opacity':0.6 } });
          } else {
            map.getSource(srcId).setData(cmp.resultGeojson);
          }
        } else if (cmp.resultCsv) {
          const a=document.createElement('a');
          a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(cmp.resultCsv);
          a.download='impact_result.csv'; a.click();
        }
      }catch(err){
        console.error(err); toast('処理に失敗しました');
      }finally{
        disable(false);
      }
    }

    document.getElementById('btnRun').onclick=()=>{
      if(!lastAOI){ toast('先にAOIを確定してください'); return; }
      try{ document.getElementById('aoi-canvas').style.pointerEvents='none'; }catch(e){}
      runPipeline(lastAOI);
    };
  </script>

<!-- traffic wiring: connect datetime UI -> system modules (non-invasive) -->
<script type="module" id="impact-traffic-wire">
  import { DATA_PATHS, VC_STYLE } from './js/system/ui-spec.js';
  import { loadSegmentsCSV, loadTrafficCSV, joinSegmentsTraffic } from './js/system/data-mapper.v3.js?v=final-20250914-145859';
  import { computeHourMetrics, proportionateDiversion } from './js/system/compute-spec.js';
  import { applyVCStyle } from './js/system/heat-style.js';
  if(typeof applyVCStyle==='function'){ applyVCStyle(window.map, 'segments-heat'); }
  // Helper: parse hour from <input type="datetime-local">
  function hourFromInput(el){
    if(!el) return 8;
    const v = el.value || '';
    // expect 'YYYY-MM-DDTHH:mm'
    const m = v.match(/T(\d{2}):(\d{2})/);
    if(m){ return Math.max(0, Math.min(23, parseInt(m[1], 10))); }
    return 8;
  }

  // GeoJSON from metrics
  function toGeoJSON(metrics, usePrime=false){
    return {
      type: 'FeatureCollection',
      features: metrics.map(r => ({
        type: 'Feature',
        geometry: r.geom,
        properties: {
          segment_id: r.segment_id,
          direction: r.direction,
          lanes: r.lanes,
          hour: r.hour,
          Vh: usePrime ? r.Vh_prime : r.Vh,
          C: r.C,
          VC: usePrime ? r.VC_prime : r.VC,
          level: usePrime ? r.level_prime : r.level,
        }
      }))
    };
  }

  // Add/update layers
  function ensureLayers(map, srcId, data){
    const L_BASE = 'segments-base';
    const L_HEAT = 'segments-heat';
    if(!map.getSource(srcId)){
      map.addSource(srcId, { type:'geojson', data });
      if(!map.getLayer(L_BASE)){
        map.addLayer({ id:L_BASE, type:'line', source:srcId,
          paint:{ 'line-color':'#808080', 'line-width':1.2, 'line-opacity':0.35 } });
      }
      if(!map.getLayer(L_HEAT)){
        // VC-based coloring using VC_STYLE thresholds
        map.addLayer({ id:L_HEAT, type:'line', source:srcId,
          paint:{
            'line-width': 3.0,
            'line-color': [
              'let','v',['get','VC'],
              ['case',
                ['<=',['var','v'], VC_STYLE[0].max], VC_STYLE[0].color,
                ['<=',['var','v'], VC_STYLE[1].max], VC_STYLE[1].color,
                ['<=',['var','v'], VC_STYLE[2].max], VC_STYLE[2].color,
                VC_STYLE[3].color
              ],
            ],
            'line-opacity': 0.95
          }
        });
      }
    } else {
      map.getSource(srcId).setData(data);
    }
  }

  // モック描画：簡易ラインを表示
  function drawMock(features){
    const fc = {type:'FeatureCollection',features};
    ensureLayers(window.map, 'segments-src', fc);
    if(window.toast) toast('モック結果を描画しました（サーバ未接続）');
    return;
  }

  // Bootstrap & wiring
  let g = { records:null, hour:8, closedIds: new Set(), useScenario:false };
  const startEl = document.querySelector('#compute #start');
  const endEl   = document.querySelector('#compute #end');
  const btnClose = document.getElementById('btnClose');

  async function bootstrap(){
    const segs = await loadSegmentsCSV(DATA_PATHS.segments);
    const traf = await loadTrafficCSV(DATA_PATHS.traffic);
    g.records = joinSegmentsTraffic(segs, traf);
    g.hour = hourFromInput(startEl);
    const metrics = computeHourMetrics(g.records, g.hour);
    const fc = toGeoJSON(metrics);
    ensureLayers(window.map, 'segments-src', fc);
    window.__impact = { ...window.__impact, records:g.records, hour:g.hour };
    if(window.toast) toast('交通量データを読み込みました');
  }

  async function rerender(){
    if(!g.records) return;
    g.hour = hourFromInput(startEl);
    let metrics = computeHourMetrics(g.records, g.hour);
    if(g.useScenario && g.closedIds.size){
      const closed = Array.from(g.closedIds);
      const res = proportionateDiversion(g.records, closed, g.hour, 3);
      metrics = res.records;
    }
    const fc = toGeoJSON(metrics, g.useScenario && g.closedIds.size>0);
    ensureLayers(window.map, 'segments-src', fc);
    applyVCStyle(window.map, 'segments-heat'); 

  }

  // UI events: time pickers change -> rerender
  [startEl, endEl].forEach(el => el && el.addEventListener('change', rerender));

  // Toggle simple scenario: click "通行止め" then click on map line -> add/remove segment_id
  if(btnClose){
    btnClose.addEventListener('click', ()=>{
      g.useScenario = !g.useScenario;
      btnClose.classList.toggle('active', g.useScenario);
      if(window.toast) toast(g.useScenario ? '通行止めモード: 地図の線をクリックで指定' : '通行止めモードを終了');
      rerender();
    });
  }

  // pick segment on click (minimal)
  window.map.on('click', (e)=>{
    if(!g.useScenario) return;
    const f = window.map.queryRenderedFeatures(e.point, { layers:['segments-heat','segments-base'] })[0];
    if(!f) return;
    const id = f.properties?.segment_id;
    if(id==null) return;
    if(g.closedIds.has(id)) g.closedIds.delete(id); else g.closedIds.add(id);
    if(window.toast) toast(`通行止め: ${id} ${g.closedIds.has(id)?'追加':'解除'}`);
    rerender();
  });

  if(window.map?.loaded()){
    bootstrap();
  } else {
    window.map?.on('load', bootstrap);
  }
</script>
<script type="module" src="./js/system/legend-wire.js"></script>
<script type="module" src="./js/system/heat-style.js"></script>

</body>
</html>
